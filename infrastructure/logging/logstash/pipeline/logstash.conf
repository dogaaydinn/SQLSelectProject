input {
  # Receive logs from Filebeat
  beats {
    port => 5044
    codec => json
  }

  # Receive logs via TCP (JSON format)
  tcp {
    port => 5000
    codec => json
  }

  # Receive logs via UDP  (for high-volume)
  udp {
    port => 5000
    codec => json
  }

  # HTTP input for direct logging
  http {
    port => 8080
    codec => json
  }
}

filter {
  # Parse JSON logs
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
    }
  }

  # Add timestamp if not present
  if ![timestamp] {
    mutate {
      add_field => { "timestamp" => "%{@timestamp}" }
    }
  }

  # Parse log level
  if [level] {
    mutate {
      lowercase => [ "level" ]
    }
  }

  # Extract service name from labels or use default
  if ![service] {
    if [labels][service] {
      mutate {
        add_field => { "service" => "%{[labels][service]}" }
      }
    } else {
      mutate {
        add_field => { "service" => "unknown" }
      }
    }
  }

  # Parse HTTP request logs
  if [http] {
    # Extract HTTP method, path, status
    if [http][method] {
      mutate {
        add_field => { "http_method" => "%{[http][method]}" }
      }
    }
    if [http][path] {
      mutate {
        add_field => { "http_path" => "%{[http][path]}" }
      }
    }
    if [http][status_code] {
      mutate {
        add_field => { "http_status" => "%{[http][status_code]}" }
        convert => { "http_status" => "integer" }
      }
    }
    if [http][response_time] {
      mutate {
        convert => { "[http][response_time]" => "float" }
      }
    }
  }

  # Parse error traces
  if [error] {
    # Add error tag
    mutate {
      add_tag => [ "error" ]
    }

    # Extract stack trace if present
    if [error][stack_trace] {
      mutate {
        add_field => { "stack_trace" => "%{[error][stack_trace]}" }
      }
    }
  }

  # Geolocate IP addresses
  if [client_ip] {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }

  # Add processing timestamp
  mutate {
    add_field => { "processed_at" => "%{@timestamp}" }
  }

  # Remove unnecessary fields
  mutate {
    remove_field => [ "host", "agent", "ecs", "input" ]
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logs-%{service}-%{+YYYY.MM.dd}"
    document_type => "_doc"
    manage_template => true
    template_name => "logs-template"
    template_pattern => "logs-*"
  }

  # Debug output (optional, remove in production)
  if [level] == "debug" or [level] == "trace" {
    stdout {
      codec => rubydebug
    }
  }

  # Send errors to separate index
  if "error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "errors-%{service}-%{+YYYY.MM.dd}"
    }
  }

  # Send metrics to Prometheus Pushgateway (optional)
  if [metrics] {
    http {
      url => "http://pushgateway:9091/metrics/job/%{service}"
      http_method => "post"
      format => "json"
    }
  }
}
