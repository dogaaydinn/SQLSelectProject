name: Deploy to Production

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version/Tag to deploy (required)'
        required: true

env:
  ENVIRONMENT: production
  NAMESPACE: employee-mgmt-prod

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate version
        run: |
          if [ -z "${{ github.event.inputs.version }}" ] && [ -z "${{ github.event.release.tag_name }}" ]; then
            echo "::error::Version must be specified"
            exit 1
          fi
          echo "Deploying version: ${{ github.event.inputs.version || github.event.release.tag_name }}"

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate
    environment:
      name: production
      url: https://employee-mgmt.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version || github.event.release.tag_name }}

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > kubeconfig
          export KUBECONFIG=./kubeconfig

      - name: Verify production cluster
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Create namespace
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy with blue-green strategy
        run: |
          # Label current deployment as blue
          kubectl label deployment/api-python version=blue -n ${{ env.NAMESPACE }} --overwrite || true

          # Deploy new version as green
          kubectl apply -f k8s/base/ -n ${{ env.NAMESPACE }}
          kubectl apply -f k8s/overlays/production/ -n ${{ env.NAMESPACE }}
          kubectl label deployment/api-python version=green -n ${{ env.NAMESPACE }} --overwrite

      - name: Wait for green deployment
        run: |
          kubectl rollout status deployment/api-python -n ${{ env.NAMESPACE }} --timeout=15m

      - name: Run production smoke tests
        run: |
          # Get the green deployment endpoint
          API_URL=$(kubectl get svc api-python-green -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' || echo "")

          if [ -z "$API_URL" ]; then
            echo "Using main service URL"
            API_URL=$(kubectl get svc api-python -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          fi

          echo "Testing API at $API_URL"

          # Health check
          curl -f http://${API_URL}/health || exit 1

          # API version check
          curl -f http://${API_URL}/api/v1/docs || exit 1

          echo "Smoke tests passed!"

      - name: Switch traffic to green (complete deployment)
        run: |
          # Update service selector to point to green deployment
          kubectl patch service api-python -n ${{ env.NAMESPACE }} -p '{"spec":{"selector":{"version":"green"}}}'

          echo "Traffic switched to new version"

      - name: Monitor for 5 minutes
        run: |
          echo "Monitoring deployment for 5 minutes..."
          sleep 300

          # Check for any pod crashes
          FAILED_PODS=$(kubectl get pods -n ${{ env.NAMESPACE }} -l version=green --field-selector=status.phase!=Running --no-headers | wc -l)

          if [ $FAILED_PODS -gt 0 ]; then
            echo "::error::Detected failed pods, initiating rollback"
            exit 1
          fi

          echo "Deployment stable"

      - name: Cleanup old blue deployment
        if: success()
        run: |
          # Scale down old deployment after successful switchover
          kubectl scale deployment/api-python --replicas=0 -n ${{ env.NAMESPACE }} -l version=blue || true
          echo "Old deployment scaled down"

      - name: Rollback on failure
        if: failure()
        run: |
          echo "::error::Deployment failed, rolling back..."

          # Switch traffic back to blue
          kubectl patch service api-python -n ${{ env.NAMESPACE }} -p '{"spec":{"selector":{"version":"blue"}}}'

          # Scale down failed green deployment
          kubectl scale deployment/api-python --replicas=0 -n ${{ env.NAMESPACE }} -l version=green

          echo "Rollback completed"
          exit 1

      - name: Deployment summary
        if: always()
        run: |
          echo "### Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.event.inputs.version || github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          kubectl get all -n ${{ env.NAMESPACE }} >> $GITHUB_STEP_SUMMARY

      - name: Notify deployment
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ðŸš€ Production Deployment: ${{ job.status }}
            Version: ${{ github.event.inputs.version || github.event.release.tag_name }}
            Commit: ${{ github.sha }}
            Actor: ${{ github.actor }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
